<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atualizador BFMIDI</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; padding: 20px; }
        .box { background: white; padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 500px; text-align: center; }
        h1 { color: #111; margin-bottom: 0.5rem; }
        .subtitle { color: #666; margin-bottom: 2rem; font-size: 0.95rem; }
        
        .btn { background: #2563eb; color: white; border: none; padding: 16px; width: 100%; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 16px; margin-top: 15px; transition: all 0.2s; }
        .btn:disabled { background: #e2e8f0; color: #94a3b8; cursor: not-allowed; }
        .btn:hover:not(:disabled) { background: #1d4ed8; }
        
        .log { background: #0f172a; color: #4ade80; padding: 15px; border-radius: 10px; text-align: left; font-family: 'SF Mono', monospace; height: 220px; overflow-y: auto; margin-top: 20px; font-size: 11px; line-height: 1.5; white-space: pre-wrap; border: 1px solid #1e293b; }
        
        .file-box { border: 2px dashed #cbd5e1; padding: 30px; border-radius: 12px; margin: 20px 0; cursor: pointer; background: #f8fafc; transition: all 0.2s; }
        .file-box:hover { background: #eff6ff; border-color: #2563eb; }

        .file-box.dragover { background: #dbeafe; border-color: #2563eb; }

        .alert { background: #fff7ed; color: #9a3412; padding: 12px; border-radius: 8px; font-size: 0.9em; margin-bottom: 15px; display: none; text-align: left; border-left: 4px solid #f97316; }
    </style>
</head>
<body>

    <div class="box">
        <h1>Atualizador BFMIDI</h1>
        <p class="subtitle">Vers√£o Definitiva (v11.0 Patch Manual)</p>

        <div id="alert-box" class="alert"></div>

        <!-- file DROP FIX REAL -->
        <div id="drop-area" class="file-box">
            <input type="file" id="fileInput" accept=".bin" style="display:none">
            <div id="file-label">
                <div style="font-size: 24px; margin-bottom: 10px">üìÇ</div>
                Clique ou solte aqui o ficheiro <b>app.bin</b>
            </div>
        </div>

        <button id="btn" class="btn" disabled>Carregue o ficheiro primeiro</button>
        <div id="log" class="log">A aguardar in√≠cio...</div>
    </div>

    <script type="module">
        import { ESPLoader, Transport } from 'https://unpkg.com/esptool-js@0.5.4/bundle.js';

        const dropArea = document.getElementById("drop-area");
        const fileInput = document.getElementById("fileInput");
        const fileLabel = document.getElementById("file-label");
        const btn = document.getElementById('btn');
        const logBox = document.getElementById('log');
        const alertBox = document.getElementById('alert-box');
        let firmwareData = null;

        const term = { clean(){}, writeLine(){}, write(){} };

        function log(msg) {
            logBox.innerHTML += `> ${msg}\n`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        function showAlert(msg) {
            alertBox.style.display = 'block';
            alertBox.innerHTML = `‚ö†Ô∏è <b>Nota:</b> ${msg}`;
        }

        // CLICK = abre seletor corretamente
        dropArea.addEventListener("click", () => fileInput.click());

        // DROP AREA FIX ‚Äì impedir comportamento padr√£o
        ["dragenter", "dragover", "dragleave", "drop"].forEach(eventName => {
            dropArea.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        // highlight
        dropArea.addEventListener("dragover", () => dropArea.classList.add("dragover"));
        dropArea.addEventListener("dragleave", () => dropArea.classList.remove("dragover"));
        dropArea.addEventListener("drop", e => {
            dropArea.classList.remove("dragover");

            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });

        // FILE INPUT
        fileInput.addEventListener("change", e => {
            const file = e.target.files[0];
            if (file) processFile(file);
        });

        // PROCESSA O FICHEIRO
        function processFile(file) {
            if (!file.name.endsWith(".bin")) {
                showAlert("Selecione um ficheiro .bin v√°lido.");
                return;
            }

            const reader = new FileReader();
            reader.onload = ev => {
                firmwareData = ev.target.result;
                fileLabel.innerHTML = `‚úÖ <b>${file.name}</b> pronto!`;
                fileLabel.style.color = "#2563eb";
                btn.disabled = false;
                btn.innerText = "LIGAR E ATUALIZAR";
                log("Ficheiro carregado. Clique no bot√£o azul.");
            };
            reader.readAsArrayBuffer(file);
        }

        // FLASHING
        btn.addEventListener('click', async () => {
            if (!firmwareData) return;

            try {
                log("A solicitar porta USB...");
                const device = await navigator.serial.requestPort();

                const transport = new Transport(device);
                if (!transport.device) transport.device = device;

                const esploader = new ESPLoader(transport, 460800, term);

                btn.disabled = true;
                btn.innerText = "A LIGAR...";
                log("A conectar...");

                await esploader.main_fn({ mode: 'default' });
                await esploader.flash_id();

                log("Chip: " + esploader.chip.CHIP_NAME);

                btn.innerText = "A GRAVAR...";

                await esploader.write_flash(
                    [{ data: firmwareData, address: 0x10000 }],
                    'keep', 'keep', 'keep',
                    false, true,
                    (i, written, total) => {
                        const p = Math.round(written / total * 100);
                        btn.innerText = `GRAVANDO ${p}%`;
                    }
                );

                log("Grava√ß√£o conclu√≠da.");
                btn.innerText = "SUCESSO!";
                btn.style.background = "#16a34a";
                btn.disabled = false;

            } catch (err) {
                log("Erro: " + err.message);
                btn.innerText = "ERRO ‚Äî TENTAR NOVAMENTE";
                btn.disabled = false;
                btn.style.background = "#dc2626";
            }
        });
    </script>
</body>
</html>
