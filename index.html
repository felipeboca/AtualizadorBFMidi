<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atualizador BFMIDI</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .box { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 480px; text-align: center; }
        h1 { color: #1a1a1a; margin-bottom: 0.5rem; }
        .btn { background: #2563eb; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .log { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; text-align: left; font-family: monospace; height: 200px; overflow-y: auto; margin-top: 20px; font-size: 12px; }
        .file-box { border: 2px dashed #ccc; padding: 20px; border-radius: 8px; margin: 20px 0; cursor: pointer; }
        .file-box:hover { background: #f9f9f9; border-color: #2563eb; }
    </style>
</head>
<body>

    <div class="box">
        <h1>Atualizador BFMIDI</h1>
        <p style="color: #666">Vers√£o Final (M√≥dulo v1.5)</p>

        <div class="file-box" onclick="document.getElementById('file').click()">
            <input type="file" id="file" accept=".bin" style="display: none">
            <div id="file-label">üìÇ Clique para selecionar <b>app.bin</b></div>
        </div>

        <button id="btn" class="btn" disabled>Aguardando ficheiro...</button>
        <div id="log" class="log">A aguardar in√≠cio...</div>
    </div>

    <!-- SCRIPT TIPO M√ìDULO (Resolve o erro 'Unexpected keyword export') -->
    <script type="module">
        import { ESPLoader, Transport } from 'https://unpkg.com/esptool-js@0.5.4/bundle.js';

        const btn = document.getElementById('btn');
        const logBox = document.getElementById('log');
        let firmwareData = null;

        function log(msg) {
            logBox.innerHTML += `> ${msg}\n`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        document.getElementById('file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                firmwareData = ev.target.result;
                document.getElementById('file-label').innerHTML = `‚úÖ <b>${file.name}</b> pronto!`;
                btn.disabled = false;
                btn.innerText = "LIGAR E ATUALIZAR";
                btn.style.backgroundColor = "#2563eb";
                log("Ficheiro carregado. Clique no bot√£o azul.");
            };
            reader.readAsArrayBuffer(file);
        });

        btn.addEventListener('click', async () => {
            try {
                // 1. Verificar suporte Web Serial
                if (!navigator.serial) {
                    throw new Error("O seu navegador n√£o suporta Web Serial. Use o Chrome ou Edge.");
                }

                // 2. Pedir Porta USB
                log("A solicitar porta USB...");
                const device = await navigator.serial.requestPort();
                
                if (!device) {
                    throw new Error("Nenhum dispositivo selecionado.");
                }
                log("Porta selecionada!");

                // 3. Configurar Conex√£o
                // A inicializa√ß√£o √© feita aqui para garantir que 'device' existe
                log("A preparar transporte...");
                const transport = new Transport(device);
                
                // 4. Configurar Loader (Velocidade 460800 √© ideal para S2 nativo)
                log("A configurar Loader...");
                const esploader = new ESPLoader(transport, 460800, null);

                // 5. Conectar
                btn.disabled = true;
                btn.innerText = "A LIGAR...";
                log("A ligar ao pedal...");
                
                // mode: 'default' √© necess√°rio para a vers√£o 0.5.4 no ESP32-S2
                await esploader.main_fn({ mode: 'default' });
                await esploader.flash_id();

                log("SUCESSO: Chip " + esploader.chip.CHIP_NAME + " detetado!");

                // 6. Gravar
                log("A iniciar grava√ß√£o em 0x10000...");
                btn.innerText = "A GRAVAR...";

                const fileArray = [{ data: firmwareData, address: 0x10000 }];
                
                await esploader.write_flash(
                    fileArray,
                    'keep', 'keep', 'keep', false, true,
                    (fileIndex, written, total) => {
                        const percent = Math.round((written / total) * 100);
                        btn.innerText = `A GRAVAR: ${percent}%`;
                        // Log a cada 10% para n√£o sobrecarregar
                        if (percent % 10 === 0 && percent > 0) log(`Progresso: ${percent}%`);
                    }
                );

                log("‚úÖ GRAVA√á√ÉO CONCLU√çDA!");
                btn.innerText = "SUCESSO!";
                btn.style.backgroundColor = "#16a34a";
                btn.disabled = false;

                // Reset
                await transport.setDTR(false);
                await transport.setRTS(true);
                await new Promise(r => setTimeout(r, 100));
                await transport.setRTS(false);
                await transport.disconnect();

            } catch (e) {
                console.error(e);
                log("‚ùå ERRO: " + e.message);
                
                if (e.message.includes("NetworkError") || e.message.includes("lost") || e.message.includes("disconnect")) {
                    log("‚ö†Ô∏è O pedal reiniciou (Dispositivo Ejetado).");
                    log("Isto √© normal em alguns S2.");
                    log("Clique em 'TENTAR NOVAMENTE' agora.");
                    btn.innerText = "TENTAR NOVAMENTE";
                    btn.style.backgroundColor = "#f59e0b";
                    btn.disabled = false;
                } else {
                    btn.innerText = "ERRO - TENTE DE NOVO";
                    btn.style.backgroundColor = "#dc2626";
                    btn.disabled = false;
                }
            }
        });
    </script>
</body>
</html>
