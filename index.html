<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atualizador BFMIDI</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; padding: 20px; }
        .box { background: white; padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 540px; text-align: center; }
        h1 { color: #111; margin-bottom: 0.5rem; }
        .subtitle { color: #666; margin-bottom: 2rem; font-size: 0.95rem; }
        
        .btn { background: #2563eb; color: white; border: none; padding: 16px; width: 100%; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 16px; margin-top: 15px; transition: all 0.2s; }
        .btn:disabled { background: #e2e8f0; color: #94a3b8; cursor: not-allowed; }
        .btn:hover:not(:disabled) { background: #1d4ed8; }
        
        .log { background: #0f172a; color: #4ade80; padding: 15px; border-radius: 10px; text-align: left; font-family: 'SF Mono', monospace; height: 220px; overflow-y: auto; margin-top: 20px; font-size: 11px; line-height: 1.5; white-space: pre-wrap; border: 1px solid #1e293b; }
        
        .file-box { border: 2px dashed #cbd5e1; padding: 30px; border-radius: 12px; margin: 20px 0; cursor: pointer; background: #f8fafc; transition: all 0.2s; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:8px; }
        .file-box:hover { background: #eff6ff; border-color: #2563eb; }
        .file-box.dragover { background:#eef9ff; border-color:#0ea5e9; box-shadow:0 6px 18px rgba(14,165,233,0.08); }
        .file-name { color:#0f172a; font-weight:600; }
        .file-hint { color:#475569; font-size:0.9rem; }

        .alert { background: #fff7ed; color: #9a3412; padding: 12px; border-radius: 8px; font-size: 0.9em; margin-bottom: 15px; display: none; text-align: left; border-left: 4px solid #f97316; }
    </style>
</head>
<body>

    <div class="box">
        <h1>Atualizador BFMIDI</h1>
        <p class="subtitle">Vers√£o Definitiva (v11.0 Patch Manual)</p>

        <div id="alert-box" class="alert"></div>

        <div id="file-box" class="file-box" title="Clique ou arraste o ficheiro app.bin">
            <div style="font-size: 28px;">üìÇ</div>
            <div id="file-label" class="file-name">Clique para selecionar o ficheiro <b>app.bin</b></div>
            <div class="file-hint">Arraste & solte ou clique para abrir o seletor</div>
            <input type="file" id="file" accept=".bin" style="display: none">
        </div>

        <button id="btn" class="btn" disabled>Carregue o ficheiro primeiro</button>
        <div id="log" class="log">A aguardar in√≠cio...</div>
    </div>

    <script type="module">
    // Usa bundle que exporta ESPLoader e TransportWebUSB
    import { ESPLoader, TransportWebUSB } from 'https://cdn.jsdelivr.net/npm/esptool-js@0.5.4/bundle.min.js';

    const btn = document.getElementById('btn');
    const logBox = document.getElementById('log');
    const alertBox = document.getElementById('alert-box');
    const fileInput = document.getElementById('file');
    const fileBox = document.getElementById('file-box');
    const fileLabel = document.getElementById('file-label');

    let firmwareData = null;
    let firmwareName = null;
    let esploader = null;
    let transport = null;

    // Terminal simulado para esptool-js
    const term = {
        clean: () => {},
        writeLine: (d) => { appendLog(String(d)); },
        write: (d) => { appendLog(String(d)); }
    };

    function appendLog(msg) {
        const now = new Date().toLocaleTimeString();
        logBox.innerText += `[${now}] ${msg}\n`;
        logBox.scrollTop = logBox.scrollHeight;
    }

    function showAlert(html) {
        alertBox.style.display = 'block';
        alertBox.innerHTML = html;
    }
    function hideAlert() {
        alertBox.style.display = 'none';
        alertBox.innerHTML = '';
    }

    // --- File handling (click + drag/drop) ---
    fileBox.addEventListener('click', () => fileInput.click());

    fileBox.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileBox.classList.add('dragover');
    });

    fileBox.addEventListener('dragleave', (e) => {
        e.preventDefault();
        fileBox.classList.remove('dragover');
    });

    fileBox.addEventListener('drop', (e) => {
        e.preventDefault();
        fileBox.classList.remove('dragover');
        if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handleFile(e.dataTransfer.files[0]);
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files.length > 0) {
            handleFile(e.target.files[0]);
        }
    });

    function handleFile(file) {
        hideAlert();

        if (!file) return;
        if (file.name.toLowerCase() !== 'app.bin') {
            showAlert('‚ö†Ô∏è Apenas ficheiro com nome <b>app.bin</b> √© permitido. Renomeie e tente novamente.');
            appendLog(`Arquivo rejeitado: ${file.name}`);
            firmwareData = null;
            firmwareName = null;
            fileLabel.innerHTML = `‚ùå ${file.name} ‚Äî renomeie para <b>app.bin</b>`;
            btn.disabled = true;
            return;
        }

        firmwareName = file.name;
        // l√™ o ficheiro
        file.arrayBuffer().then(buf => {
            firmwareData = buf;
            fileLabel.innerHTML = `‚úÖ <b>${file.name}</b> pronto para enviar`;
            appendLog(`Ficheiro carregado: ${file.name} (${(file.size/1024).toFixed(1)} KB)`);
            btn.disabled = false;
            btn.innerText = "LIGAR E ATUALIZAR";
        }).catch(err => {
            firmwareData = null;
            appendLog('Erro ao ler ficheiro: ' + err);
            showAlert('Erro ao ler ficheiro. Tente novamente.');
        });
    }

    // --- Bot√£o principal ---
    btn.addEventListener('click', async () => {
        // evita duplo clique durante processo
        if (btn.innerText.includes("A LIGAR") || btn.innerText.includes("A GRAVAR")) return;

        try {
            hideAlert();

            if (!firmwareData) {
                appendLog("Nenhum ficheiro carregado.");
                return;
            }

            // Verifica WebUSB suportado
            if (!navigator.usb) {
                throw new Error("Navegador sem suporte WebUSB. Use Chrome/Edge e sirva a p√°gina via HTTPS ou localhost.");
            }

            appendLog("A solicitar dispositivo USB (WebUSB)...");
            // Filtro com VID Espressif. Se n√£o aparecer, remova filters.
            const device = await navigator.usb.requestDevice({ filters: [{ vendorId: 0x303a }] });

            if (!device) throw new Error("Nenhum dispositivo selecionado.");

            appendLog("Dispositivo selecionado: " + (device.productName || 'USB device'));

            // Cria transport WebUSB e esploader
            transport = new TransportWebUSB(device);

            // Alguns bundles requerem open expl√≠cito ‚Äî tenta com seguran√ßa
            if (typeof transport.open === 'function') {
                try { await transport.open(); } catch(e) { /* ignora se j√° aberto internamente */ }
            }

            esploader = new ESPLoader(transport, 460800, term);

            btn.disabled = true;
            btn.innerText = "A LIGAR...";
            appendLog("A conectar ao bootloader...");

            // Conectar e detectar
            await esploader.main_fn({ mode: 'default' });
            await esploader.flash_id();

            appendLog("‚úÖ Chip detectado: " + (esploader.chip && esploader.chip.CHIP_NAME ? esploader.chip.CHIP_NAME : 'UNKNOWN'));
            appendLog("A preparar grava√ß√£o...");

            // Prepara grava√ß√£o apenas de app.bin em 0x10000
            const fileArray = [{ data: firmwareData, address: 0x10000 }];

            btn.innerText = "A GRAVAR... N√ÉO DESLIGUE";

            await esploader.write_flash(
                fileArray,
                'keep', 'keep', 'keep', false, true,
                (fileIndex, written, total) => {
                    const percent = Math.round((written / total) * 100);
                    btn.innerText = `A GRAVAR: ${percent}%`;
                    if (percent % 10 === 0) appendLog(`Progresso: ${percent}%`);
                }
            );

            appendLog("‚úÖ GRAVA√á√ÉO CONCLU√çDA!");
            btn.innerText = "SUCESSO! REINICIE O PEDAL";
            btn.style.backgroundColor = "#16a34a";
            btn.disabled = false;

            // Tentativa de reset gracioso
            try {
                if (typeof transport.setDTR === 'function') await transport.setDTR(false);
                if (typeof transport.setRTS === 'function') {
                    await transport.setRTS(true);
                    await new Promise(r => setTimeout(r, 120));
                    await transport.setRTS(false);
                }
            } catch(e) {}

            // Desconectar
            try { if (typeof transport.disconnect === 'function') await transport.disconnect(); } catch(e) {}

        } catch (e) {
            console.error(e);
            const msg = e && e.message ? e.message : String(e);

            // Mensagens esperadas quando o dispositivo reinicia durante o processo
            if (msg.includes("NetworkError") || msg.includes("lost") || msg.includes("disconnected") || msg.includes("cannot") ) {
                appendLog("\n‚ö†Ô∏è O dispositivo pode ter reiniciado (comportamento normal).");
                appendLog("Se o seu sistema montou um dispositivo USB, seleccione-o novamente.");
                showAlert("O dispositivo reiniciou. Selecione o dispositivo outra vez e clique em LIGAR E ATUALIZAR se necess√°rio.");
                btn.innerText = "CONTINUAR (TENTAR NOVAMENTE)";
                btn.style.backgroundColor = "#f59e0b";
                btn.disabled = false;
            } else {
                appendLog("‚ùå ERRO: " + msg);
                showAlert("<b>Erro:</b> " + msg);
                btn.innerText = "ERRO - TENTE DE NOVO";
                btn.style.backgroundColor = "#dc2626";
                btn.disabled = false;
            }
        }
    });

    // Log inicial
    appendLog("Interface pronta. Carregue o ficheiro app.bin ou arraste para a caixa acima.");
    appendLog("Nota: sirva esta p√°gina via http://localhost ou HTTPS (Chrome bloqueia recursos quando aberto via file://).");
    </script>
</body>
</html>
