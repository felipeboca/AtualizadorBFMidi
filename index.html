<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atualizador BFMIDI</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; padding: 20px; }
        .box { background: white; padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 650px; text-align: center; }
        h1 { color: #111; margin-bottom: 0.5rem; }
        .subtitle { color: #666; margin-bottom: 2rem; font-size: 0.95rem; }
        
        .btn { background: #2563eb; color: white; border: none; padding: 16px; width: 100%; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 16px; margin-top: 15px; transition: all 0.2s; }
        .btn:disabled { background: #e2e8f0; color: #94a3b8; cursor: not-allowed; }
        .btn:hover:not(:disabled) { background: #1d4ed8; }
        
        .log { background: #1e1e1e; color: #e2e8f0; padding: 15px; border-radius: 10px; text-align: left; font-family: 'SF Mono', monospace; height: 350px; overflow-y: auto; margin-top: 20px; font-size: 11px; line-height: 1.5; white-space: pre-wrap; border: 1px solid #333; }
        
        .file-box { border: 2px dashed #cbd5e1; padding: 30px; border-radius: 12px; margin: 20px 0; cursor: pointer; background: #f8fafc; transition: all 0.2s; }
        .file-box:hover { background: #eff6ff; border-color: #2563eb; }
        
        .options { display: flex; gap: 10px; margin-top: 10px; justify-content: center; }
        select { padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
    </style>
</head>
<body>

    <div class="box">
        <h1>Atualizador BFMIDI</h1>
        <p class="subtitle">Vers√£o Final (v29.0 M√≥dulo + Seletor de Velocidade)</p>

        <div class="file-box" onclick="document.getElementById('file').click()">
            <input type="file" id="file" accept=".bin" style="display: none">
            <div id="file-label">
                <div style="font-size: 24px; margin-bottom: 10px">üìÇ</div>
                Clique para selecionar o ficheiro <b>app.bin</b>
            </div>
        </div>

        <div class="options">
            <label>Velocidade:
                <select id="baudrate">
                    <option value="115200">115200 (Lento/Seguro)</option>
                    <option value="230400">230400 (M√©dio)</option>
                    <option value="460800" selected>460800 (R√°pido - Padr√£o S2)</option>
                    <option value="921600">921600 (Turbo)</option>
                </select>
            </label>
        </div>

        <button id="btn" class="btn" disabled>Carregue o ficheiro primeiro</button>
        <div id="log" class="log">A aguardar in√≠cio...</div>
    </div>

    <!-- VOLTAMOS AO M√ìDULO para corrigir o erro de sintaxe -->
    <script type="module">
        import { ESPLoader, Transport } from 'https://unpkg.com/esptool-js@0.2.0/bundle.js';

        const btn = document.getElementById('btn');
        const logBox = document.getElementById('log');
        const baudSelect = document.getElementById('baudrate');
        let firmwareData = null;

        // Terminal Simulado (Captura logs internos da biblioteca)
        const term = {
            clean: () => {},
            writeLine: (d) => { log("LIB: " + d); },
            write: (d) => { /* log("RAW: " + d); */ }
        };

        function log(msg) {
            logBox.innerHTML += `${msg}\n`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        document.getElementById('file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                firmwareData = ev.target.result;
                document.getElementById('file-label').innerHTML = `‚úÖ <b>${file.name}</b> pronto!`;
                document.getElementById('file-label').style.color = '#2563eb';
                btn.disabled = false;
                btn.innerText = "LIGAR E ATUALIZAR";
                log(`> Ficheiro carregado. Clique no bot√£o azul.`);
            };
            reader.readAsArrayBuffer(file);
        });

        btn.addEventListener('click', async () => {
            if(btn.innerText.includes("...")) return;

            try {
                if (!navigator.serial) throw new Error("Navegador incompat√≠vel. Use Chrome/Edge.");

                const baudRate = parseInt(baudSelect.value);
                log(`> A solicitar porta USB (Velocidade: ${baudRate})...`);
                
                const device = await navigator.serial.requestPort();
                log("> Porta selecionada. A iniciar...");

                const transport = new Transport(device);
                const esploader = new ESPLoader(transport, baudRate, term);

                btn.disabled = true;
                btn.innerText = "A LIGAR...";
                
                log("> A conectar...");
                
                // Tenta conectar. Se o dispositivo estiver em modo App, ele vai resetar.
                try {
                    await esploader.main_fn();
                    await esploader.flash_id();
                } catch (err) {
                    // Se falhar aqui, pode ser porque o dispositivo reiniciou (ejetou)
                    // ou porque o reset falhou.
                    console.error(err);
                    throw new Error("Falha na conex√£o inicial. Se o pedal reiniciou, tente novamente.");
                }

                log("> ‚úÖ Chip detetado: " + esploader.chip.CHIP_NAME);
                log("> A preparar grava√ß√£o...");

                const fileArray = [{ data: firmwareData, address: 0x10000 }];
                btn.innerText = "A GRAVAR... N√ÉO DESLIGUE";
                
                // Grava√ß√£o
                await esploader.write_flash(
                    fileArray,
                    'keep', 'keep', 'keep', false, true,
                    (fileIndex, written, total) => {
                        const percent = Math.round((written / total) * 100);
                        btn.innerText = `GRAVANDO: ${percent}%`;
                        if (percent % 5 === 0) log(`> Progresso: ${percent}%`);
                    }
                );

                log("> ‚úÖ GRAVA√á√ÉO CONCLU√çDA!");
                btn.innerText = "SUCESSO! REINICIE O PEDAL";
                btn.style.backgroundColor = "#16a34a";
                btn.disabled = false;

                // Reset Final
                try {
                    await transport.setDTR(false);
                    await transport.setRTS(true);
                    await new Promise(r => setTimeout(r, 100));
                    await transport.setRTS(false);
                } catch(e) {}
                
                await transport.disconnect();

            } catch (e) {
                console.error(e);
                const msg = e.message || e.toString();
                
                log(`> ‚ùå ERRO: ${msg}`);
                
                if (msg.includes("Timeout")) {
                    log("> ERRO DE TIMEOUT.");
                    log("> Solu√ß√£o 1: Tente selecionar uma velocidade menor (ex: 230400).");
                    log("> Solu√ß√£o 2: Desconecte e reconecte o cabo USB.");
                    btn.innerText = "TENTAR NOVAMENTE";
                    btn.disabled = false;
                    btn.style.backgroundColor = "#f59e0b";
                } else if (msg.includes("NetworkError") || msg.includes("lost") || msg.includes("disconnect")) {
                    log("> O pedal reiniciou (Disco Ejetado).");
                    log("> Isto √© normal na primeira tentativa se ele n√£o estava em modo Boot.");
                    log("> CLIQUE EM 'TENTAR NOVAMENTE' AGORA.");
                    btn.innerText = "TENTAR NOVAMENTE";
                    btn.disabled = false;
                    btn.style.backgroundColor = "#f59e0b";
                } else {
                    btn.innerText = "ERRO - TENTE DE NOVO";
                    btn.disabled = false;
                    btn.style.backgroundColor = "#dc2626";
                }
            }
        });
    </script>
</body>
</html>
```I made some changes. Corrigi o erro de sintaxe voltando a usar o carregamento via m√≥dulo (`type="module"`), que √© obrigat√≥rio para a biblioteca `esptool-js` funcionar no navegador moderno. Adicionei tamb√©m um seletor de velocidade para que possa ajustar entre 115200 e 460800 caso encontre problemas de "Timeout".

**Instru√ß√µes:**
1.  Atualize o ficheiro.
2.  Tente primeiro com a velocidade padr√£o (**460800**).
3.  Se der "Timeout", mude para **230400** ou **115200** e tente de novo.
4.  Se der erro de "Disco Ejetado" (rein√≠cio), clique imediatamente em **TENTAR NOVAMENTE** assim que o bot√£o ficar amarelo.
