<script type="module">
    import { ESPLoader, Transport } from "https://unpkg.com/esptool-js@0.4.1/dist/web/index.js";

    const fileInput = document.getElementById("file");
    const fileBox = document.querySelector(".file-box");
    const fileLabel = document.getElementById("file-label");
    const btn = document.getElementById("btn");
    const logBox = document.getElementById("log");
    const alertBox = document.getElementById("alert-box");

    let firmwareData = null;

    const term = { clean(){}, writeLine(){}, write(){} };

    function log(msg) {
        logBox.innerHTML += `> ${msg}\n`;
        logBox.scrollTop = logBox.scrollHeight;
    }

    function showAlert(msg) {
        alertBox.style.display = "block";
        alertBox.innerHTML = `⚠️ <b>Nota:</b> ${msg}`;
    }

    // Selecionar ficheiro
    fileBox.onclick = () => fileInput.click();

    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = ev => {
            firmwareData = ev.target.result;
            fileLabel.innerHTML = `✅ <b>${file.name}</b> carregado`;
            btn.disabled = false;
            btn.innerText = "LIGAR E ATUALIZAR";
            log("Ficheiro carregado. Clique no botão azul.");
        };
        reader.readAsArrayBuffer(file);
    };

    btn.onclick = async () => {
        if (!firmwareData) return;

        try {
            log("A solicitar porta USB...");
            const device = await navigator.serial.requestPort();
            log("Porta capturada!");

            const transport = new Transport(device);
            const esploader = new ESPLoader(transport, 460800, term);

            btn.disabled = true;
            btn.innerText = "A LIGAR...";

            await esploader.main_fn();
            await esploader.flash_id();

            log("Chip detetado: " + esploader.chipName);

            btn.innerText = "A GRAVAR...";

            await esploader.write_flash(
                [{ data: firmwareData, address: 0x10000 }],
                "keep", "keep", "keep",
                false, true,
                (i, written, total) => {
                    const p = Math.round((written / total) * 100);
                    btn.innerText = `GRAVANDO ${p}%`;
                }
            );

            log("Gravação concluída!");
            btn.innerText = "SUCESSO!";
            btn.style.background = "#16a34a";
            btn.disabled = false;

        } catch (err) {
            console.error(err);
            log("Erro: " + err.message);
            showAlert(err.message);
            btn.innerText = "ERRO — TENTAR NOVAMENTE";
            btn.style.background = "#dc2626";
            btn.disabled = false;
        }
    };
</script>
